Checkin={checkinable:false};var i=1;Checkin.handle=function(){if($("#qrinput").val().indexOf(";")>0){$("#qrinput").css("color","#fff");if(i==1){i++;var info=new Array();info=$("#qrinput").val().split(";");var code=info[0].split(":")[1];if(code!=undefined){$("#checkin_infoForm")[0].reset();$("#checkin_addForm")[0].reset();$.post("admin/userAction!findUserByCode",{code:code},function(data){if(data.user.name==null||data.user.name==""){$("#aCode").val(code);$("#imageName").val(code+".png");$("#qrinput").val("");$("#checkin_add_dialog").dialog("option","buttons",{"签到":function(){var phone=$("#checkin_addForm input[name='user.phone']").get(0);var email=$("#checkin_addForm input[name='user.email']").get(0);var $aName=$("#checkin_addForm input[name='user.name']");if($aName.val()==""){alert("请输入姓名");$aName.focus();return false}else{if(Utils.check_telephone(phone)===true&&Utils.check_email(email)===true){$("input[name='checkinWay']").val(1);$("#checkin_addForm").submit()}}},"取消":function(){$("#checkin_add_dialog").dialog("close")}});$("#checkin_add_dialog").dialog("open");$("#checkin_addForm input[name='user.name']").blur()}else{Checkin.find(code)}setTimeout(function(){i=1},500)})}else{i=1}}}};Checkin.addCallback=function(msg,status){if(msg.status==200){alert("添加成功！")}else{if(msg.status==501){alert("该用户已经存在");$("#checkin_addForm input[name='user.phone']").val("").focus();return false}else{if(msg.status==412){alert("添加成功，并签到")}else{alert("服务器内部错误！")}}}$("#checkin_add_dialog").dialog("close")};Checkin.find_2=function(code){$("#qrinput").css("color","#fff").val(code);Checkin.find(code)};Checkin.find=function(QRcode){if($("#qrinput").val()==""){alert("请输入用户编码或手机号");$("#qrinput").focus()}else{if(QRcode==null||QRcode==""){QRcode=$("#qrinput").val()}$.post("admin/userAction!findUserByCode",{code:QRcode},function(data){var u=data.user;var uL=data.userList;var selectedType;var ucon;$("#conference_box input[type=radio]").each(function(){if($(this).attr("checked")==="checked"){selectedType=$(this).val()}});var $iCode=$("#checkin_infoForm input[name='user.code']");var $iName=$("#checkin_infoForm input[name='user.name']");var $iType=$("#checkin_infoForm input[name='user.type']");var $iPhone=$("#checkin_infoForm input[name='user.phone']");var $iCompany=$("#checkin_infoForm input[name='user.company']");var $iEmail=$("#checkin_infoForm input[name='user.email']");var $iTitle=$("#checkin_infoForm input[name='user.title']");var $iSeatNumber=$("#checkin_infoForm input[name='user.seatNumber']");var $iCompanyAdd=$("#checkin_infoForm input[name='user.companyAdd']");var $iDaren=$("#checkin_infoForm input[name='user.daren']");var $iPrize=$("#checkin_infoForm input[name='user.prize']");var $iPhotoName=$("#checkin_infoForm input[name='user.photoName']");var $iNote=$("#checkin_infoForm textarea[name='user.note']");if(data.status==200){Checkin.checkinable=false;if(u!==null||uL.length===1){u=u||uL[0];if(selectedType!==undefined&&selectedType!==""){ucon=u.conferences;for(var i=0;i<ucon.length;i++){if(selectedType==ucon[i].id){Checkin.checkinable=true;break}}}else{Checkin.checkinable=true}$iCode.val(u.code);$iName.val(u.name);var userType=u.userType;if(userType==null||userType==""){$iType.parent().parent().hide()}else{$iType.parent().parent().show();$iType.val(userType.typeName)}Checkin.hideOrShow($iPhone,u.phone);Checkin.hideOrShow($iCompany,u.company);Checkin.hideOrShow($iEmail,u.email);Checkin.hideOrShow($iTitle,u.title);Checkin.hideOrShow($iCompanyAdd,u.companyAdd);Checkin.hideOrShow($iSeatNumber,u.seatNumber);Checkin.hideOrShow($iDaren,u.daren);Checkin.hideOrShow($iPrize,u.prize);Checkin.hideOrShow($iPhotoName,u.photoName);Checkin.hideOrShow($iNote,u.note);var c=u.conferences;if(c!==undefined){headTr='<tr>								 <td width="15%">会议编码</td>								 <td width="15%">会议地点</td>								 <td width="50%">会议内容</td>								 <td width="20%">会议时间</td>								 </tr>';$("#user_permission table").append(headTr);for(var i=0;i<c.length;i++){var conferenceDate=c[i].conferenceDate.replace(/\d{4}-(\d{2})-(\d{2})T00:00:00/g,"$1月$2日");var conferenceTr=document.createElement("tr");if(selectedType===undefined||selectedType===""||selectedType==c[i].id){conferenceTr.style.color="red"}$(conferenceTr).append("<td>"+c[i].id+"</td><td>"+(c[i].floor==null||c[i].floor===""?"":c[i].floor+" ")+c[i].conferenceRoom+"</td><td>"+c[i].conferenceContent+"</td><td>"+conferenceDate+"</td>");$("#user_permission table").append($(conferenceTr))}}if($("#user_permission table tr").length===1){$("#user_permission").css("display","none")}var $checkinInfoDialog=$("#checkin_info_dialog");var $checkinWay=$("input[name='checkinWay']");if(u.checkinRecds.length<data.checkinMaxNum){$checkinInfoDialog.dialog("option","buttons",{"签到":function(){if(Checkin.checkinable){$.post("admin/checkinAction!checkin",{code:$iCode.val(),checkinWay:$checkinWay.val()},function(data){if(data.status==200){alert("签到成功");$("#"+u.code).next().text("已签到")}else{if(data.status==400){alert("签到失败，没有找到用户！")}else{if(data.status==510){alert("该用户已经签到！")}else{if(data.status==412){alert("请求失败，请重试！")}else{alert("服务器内部错误！")}}}}$checkinInfoDialog.dialog("close")})}else{alert("您没有参加这场会的权限")}},"取消":function(){$(this).dialog("close")}});if(QRcode==null&&QRcode==""){$checkinWay.val(1)}else{$checkinWay.val(0)}}else{$("#checkin_info_dialog").dialog("option","buttons",{"关闭":function(){$(this).dialog("close")}})}$checkinInfoDialog.dialog("open")}else{if(uL!==null){var ticketBox="";for(var i=0;i<uL.length;i++){var userCode=uL[i].code;ticketBox+='<li><span>胸卡类型：</span><a id="'+userCode+"\" href='javascript:void(0);' onclick=\"Checkin.find_2('"+userCode+"')\" >"+uL[i].userType.typeName+"</a><span>"+(uL[i].checkinRecds.length===0?"未签到":"已签到")+"</span></li>"}$("#ticketForm ul").append(ticketBox);$("#checkin_ticket_dialog").dialog("open")}}}else{if(data.status==404){alert("没有找到该用户")}else{if(data.status==412){alert("请求失败，请重试！")}else{alert("服务器内部错误！")}}}$("#qrinput").val("")})}};Checkin.hideOrShow=function(jObj,value){if(value==null||value==""){jObj.parent().parent().hide()}else{jObj.parent().parent().show();jObj.val(value)}};Checkin.remove=function(){$("#user_permission table tr").remove()};Loader={};Loader.config={background:"#E6E6E6",opacity:"0.7"};Loader.showLoader=function(opt){var shadeWidth;var shadeHeight;var typeOfOpt=typeof (opt);if(opt==null){shadeWidth=document.body.clientWidth;shadeHeight=document.body.offsetHeight}else{if(typeOfOpt=="object"){shadeWidth=opt.width;shadeHeight=opt.height}else{if(typeOfOpt=="string"){var obj=document.getElementById("opt");shadeWidth=obj.width;shadeHeight=obj.height}}}var canvasBox=document.createElement("div");canvasBox.id="canvas_box";canvasBox.style.position="absolute";canvasBox.style.width=shadeWidth+"px";canvasBox.style.height=shadeHeight+"px";canvasBox.style.top="0px";canvasBox.style.zIndex=1000;canvasBox.style.background=Loader.config.background;canvasBox.style.opacity=Loader.config.opacity;var divBox=document.createElement("div");divBox.id="canvasloader-container";divBox.style.position="absolute";divBox.style.top="35%";divBox.style.left="50%";canvasBox.appendChild(divBox);document.body.appendChild(canvasBox);var cl=new CanvasLoader("canvasloader-container");cl.setShape("spiral");cl.setDensity(50);cl.setDiameter(60);cl.show();var loaderObj=document.getElementById("canvasLoader");loaderObj.style.position="absolute";loaderObj.style.top=cl.getDiameter()*-0.5+"px";loaderObj.style.left=cl.getDiameter()*-0.5+"px"};Loader.killLoader=function(){var loaderObj=document.getElementById("canvas_box");if(loaderObj!=null){loaderObj.parentNode.removeChild(loaderObj)}};Main={headLineArr:["编码","姓名","胸卡类型","电话","公司","邮箱","备注"],addHeadLine:function(jqeruyObj,headLineArr,colon){hla=this.headLineArr;if(headLineArr&&Utils.is_array(headLineArr)){hla=headLineArr}jqeruyObj.each(function(index){if(!$(this).text()){$(this).text(hla[index]+(colon?colon:""))}})},addCheckinSelect:function(jqeruyObj){var optionBox;if(Main.checkinMaxNum===1){for(var i=0;i<=Main.checkinMaxNum;i++){optionBox=document.createElement("option");optionBox.value=i;if(i===0){optionBox.innerHTML="未签到"}else{optionBox.innerHTML="已签到"}jqeruyObj.append(optionBox)}}else{for(var i=0;i<=Main.checkinMaxNum;i++){optionBox=document.createElement("option");optionBox.value=i;optionBox.innerHTML=i+"次";jqeruyObj.append(optionBox)}}},addTypeSelect:function(){$.post("admin/userAction!gainUserType",function(data){var uts=data.userTypes;var typeOption;for(var i=0;i<uts.length;i++){var ut=uts[i];typeOption=document.createElement("option");typeOption.value=ut.id;typeOption.innerHTML=ut.typeName;$('select[name="user.type"]').append(typeOption)}})}};Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}}return format};$(function(){$("#ucheckall").click(function(){if($(this).attr("checked")=="checked"){$("input[name='ucheckbox']").each(function(){$(this).attr("checked",true)})}else{$("input[name='ucheckbox']").each(function(){$(this).attr("checked",false)})}})});Sms={};Sms.callBack=function(msg,status){Loader.killLoader();if(msg.status==200){$("#infoTable tbody").empty();var us=msg.users.data;if(us.length>0){for(i=0;i<us.length;i++){var tr=$("<tr>");tr.append("<td><input type='checkbox' name='ucheckbox' value='"+us[i].id+"'/></td>").append("<td>"+(us[i].code==null?"":us[i].code)+"</td>").append("<td>"+(us[i].name==null?"":us[i].name)+"</td>").append("<td>"+(us[i].userType==null?"":us[i].userType.typeName)+"</td>").append("<td>"+(us[i].phone==null?"":us[i].phone)+"</td>").append("<td>"+(us[i].company==null?"":us[i].company)+"</td>").append("<td>"+(us[i].email==null?"":us[i].email)+"</td>");tr.append("<td>"+(us[i].note==null?"":us[i].note)+"</td>").append("<td>"+us[i].smsSendRecds.length+"</td>");if(us[i].name!=null&&us[i].name!=""){if(us[i].smsSendRecds.length==0){tr.append("<td><button onclick=Sms.sendSms('"+us[i].id+"')>发送</button></td>")}else{tr.append("<td><button onclick=Sms.sendSms("+us[i].id+")>重发</button></td>")}}else{tr.append("<td></td>")}$("#infoTable tbody").append(tr)}$("#totalCount").html(msg.users.totalCount);$('#sms_conditionForm input[name="page"]').val(msg.users.currentPage);$("#currentPage").html(msg.users.currentPage);$("#totalPage").html(msg.users.totalPage);$("#ucheckall").attr("checked",false)}else{$("#infoTable tbody").append("<tr><td colspan='11'>没有记录</td></tr>")}}else{alert("服务器内部错误！")}Sms.initPageButton()};Sms.sendSms=function(id){$("#send_sms_dialog").dialog("open");$.post("admin/sendSmsAction!send",{userId:id},function(data){if(data.status==200){Sms.processResult(data)}else{if(data.status==412){$("#send_info").html("请求失败，请重试！")}else{$("#send_info").html("服务器内部错误！")}}})};Sms.sendSmsSelected=function(){if($("input[name='ucheckbox']:checked").length==0){alert("请选择要发送短信的用户！")}else{var ids=new Array();$("input[name='ucheckbox']:checked").each(function(){ids.push($(this).val())});var userIds={userIds:ids};$("#send_sms_dialog").dialog("open");$.ajax({url:"admin/sendSmsAction!sendBulkSms",dataType:"json",data:$.param(userIds,true),success:function(data){if(data.status==200){Sms.processResult(data)}else{if(data.status==412){$("#send_info").html("请求失败，请重试！")}else{$("#send_info").html("服务器内部错误！")}}}})}};Sms.sendAll=function(){$("#send_sms_dialog").dialog("open");$.post("admin/sendSmsAction!sendToAll",{},function(data){if(data.status==200){Sms.processResult(data)}else{$("#send_info").html("服务器内部错误！")}})};Sms.processResult=function(data){$("#send_info").html("");$("#send_info").append("<div>短信成功发送: "+data.successCount+" 条</div>");$("#send_info").append("<div>短信发送失败:"+(data.errs==null?0:data.errs.length)+" 条</div>");if(data.errs!=null&&data.errs.length>0){var errPhones="";for(i=0;i<data.errs.length;i++){errPhones=errPhones+data.errs[i]+";"}errPhones=errPhones.substring(0,errPhones.length-1);$("#send_info").append("");$("#send_info").append("<div>短信发送失败号码:["+errPhones+"]</div>")}$("#send_info").append("<div>邮件成功发送: "+data.emailSuccessCount+" 封</div>");$("#send_info").append("<div>邮件发送失败:"+(data.emailErrs==null?0:data.emailErrs.length)+" 封</div>");if(data.emailErrs!=null&&data.emailErrs.length>0){var errEmails="";for(i=0;i<data.emailErrs.length;i++){errEmails=errEmails+data.emailErrs[i]+";"}errEmails=errEmails.substring(0,errEmails.length-1);$("#send_info").append("");$("#send_info").append("<div>邮件发送失败地址:["+errEmails+"]</div>")}};Sms.find=function(){Loader.showLoader();$('#sms_conditionForm input[name="page"]').val(1);$("#sms_conditionForm").submit()};Sms.changePage=function(page){Loader.showLoader();$('#sms_conditionForm input[name="page"]').val(page);$("#sms_conditionForm").submit()};Sms.first=function(){Sms.changePage(1)};Sms.end=function(){Sms.changePage(parseInt($("#totalPage").html()))};Sms.back=function(){Sms.changePage(parseInt($("#page").val())-1)};Sms.next=function(){Sms.changePage(parseInt($("#page").val())+1)};Sms.gotoPage=function(){Sms.changePage(parseInt($("#anyPage").val()))};Sms.initPageButton=function(){if(parseInt($("#currentPage").html())>1){$("#sms_first").show();$("#sms_back").show()}else{$("#sms_first").hide();$("#sms_back").hide()}if(parseInt($("#currentPage").html())<parseInt($("#totalPage").html())){$("#sms_next").show();$("#sms_last").show()}else{$("#sms_next").hide();$("#sms_last").hide()}};User={};User.orderByCode=function(index,imageName){$("#orderType").val(index);$("#arrow_code").attr("src","../images/"+imageName);$("#arrow_date").hide();$("#arrow_code").show();User.findUsersByCodeOrDate()};User.infoIterator=function(u){if(!Utils.is_array(u)){us=[u]}else{us=u}for(i=0;i<us.length;i++){var tr=$("<tr>");tr.append("<td><input type='checkbox' name='ucheckbox' value='"+us[i].id+"'/></td>").append("<td>"+Utils.transform(us[i].code)+"</td>").append("<td>"+Utils.transform(us[i].name)+"</td>");if(us[i].userType!==undefined&&us[i].userType!==null){tr.append("<td>"+Utils.transform(us[i].userType.typeName)+"</td>")}else{tr.append("<td></td>")}tr.append("<td>"+Utils.transform(us[i].phone)+"</td>").append("<td>"+Utils.transform(us[i].company)+"</td>").append("<td>"+Utils.transform(us[i].email)+"</td>");if(us[i].name!=null&&us[i].name!=""){if(us[i].checkinRecds.length<Main.checkinMaxNum){tr.append("<td><a href='javascript:void(0)' onclick=User.bgCheckin('"+us[i].code+"')>签到</a></td>")}else{tr.append("<td><a href='javascript:void(0)' onclick=User.checkout("+us[i].id+")>取消签到</a></td>")}tr.append("<td><a href='print.jsp?c="+us[i].code+"' target='_blank')>打印</a></td>")}else{tr.append("<td></td>");tr.append("<td></td>")}tr.append("<td><a href='javascript:void(0)' onclick=User.updateUser('"+us[i].code+"',this)>编辑</a></td>");if(!Utils.is_array(u)){User.config.updateTr.replaceWith(tr)}else{$("#user_infoTable tbody").append(tr)}}};User.callBack=function(msg,status){Loader.killLoader();if(msg.status==200){$("#user_infoTable tbody").empty();var us=msg.users.data;if(us.length>0){User.infoIterator(us);$("#totalCount").html(msg.users.totalCount);$('#user_conditionForm input[name="page"]').val(msg.users.currentPage);$("#currentPage").html(msg.users.currentPage);$("#totalPage").html(msg.users.totalPage);$("#ucheckall").attr("checked",false)}else{$("#user_infoTable tbody").append("<tr><td colspan='100'>没有记录</td></tr>")}User.initPageButton()}else{alert("服务器内部错误！")}};User.bgCheckin=function(code){$.post("admin/checkinAction!bgCheckin",{code:code},function(data){User.checkinCallback(data)})};User.checkinCallback=function(data){if(data.status==200){alert("签到成功");$("#user_conditionForm").submit()}else{if(data.status==400){alert("签到失败，没有找到用户！")}else{if(data.status==510){alert("该用户已经签到！")}else{if(data.status==412){alert("请求失败，请重试！")}else{alert("服务器内部错误！")}}}}};User.checkout=function(id){$.post("admin/checkinAction!checkout",{userId:id},function(data){if(data.status==200){alert("取消成功");$("#user_conditionForm").submit()}else{if(data.status==412){alert("请求失败，请重试！")}else{alert("服务器内部错误！")}}})};User.exportExcel=function(){var vform=$("#user_conditionForm").clone();$("body").append(vform);vform.hide();vform.attr("action","admin/userAction!exportExcel");vform.attr("id","vform");$("#vform input").each(function(i){$(this).val($("#user_conditionForm input").eq(i).val())});$("#vform select").each(function(i){$(this).val($("#user_conditionForm select").eq(i).val())});vform.submit();vform.remove()};User.findUsersByCodeOrDate=function(){$('#user_conditionForm input[name="page"]').val(1);$("#user_conditionForm").attr("action","admin/userAction!orderByCodeOrDate");$("#user_conditionForm").submit()};User.add=function(){$("#user_add_dialog #utype option[value=0]").attr("selected","selected");$("#user_add_dialog").dialog("open")};User.addCallback=function(msg,status){if(msg.status==200){alert("添加成功！");$("#user_add_dialog").dialog("close");User.find()}else{if(msg.status==501){alert("该用户已经存在")}else{alert("添加失败！")}}};User.delUser=function(){if($("input[name='ucheckbox']:checked").length===0){alert("请先选择要删除的记录！")}else{if(window.confirm("你确定要删除该记录！")){var ids=new Array();$("input[name='ucheckbox']:checked").each(function(){ids.push($(this).val())});var delIds={delIds:ids};$.ajax({url:"admin/userAction!delete",dataType:"json",data:$.param(delIds,true),success:function(data){if(data.status==200){alert("删除成功！");$("#user_conditionForm").submit()}else{alert("删除失败，请重试！")}}})}else{return }}};User.config={updateFlag:false,updateTr:null};User.updateUser=function(code,obj){User.config.updateFlag=true;User.config.updateTr=$(obj).parent().parent();$.post("admin/userAction!findUserByCode",{code:code},function(data){if(data.status==200){var u=data.user;if(u!=null&&u!=""){$("#utype option[value="+u.type+"]").attr("selected","selected");$("#uid").val(u.id);$("#ucode").val(u.code);$("#uname").val(u.name);$("#uphone").val(u.phone);$("#ucompany").val(u.company);$("#uemail").val(u.email);$("#info").val(u.note);$("#user_add_dialog").dialog("open")}else{alert("不存在此用户或此用户已被删除！")}}},"json")};User.addTemporaryUser=function(){$("#user_infoForm").submit()};User.find=function(){$('#user_conditionForm input[name="page"]').val(1);Loader.showLoader();$("#user_conditionForm").submit()};User.toPrint=function(code){window.location.href="print.jsp?c="+code};User.changePage=function(page){$('#user_conditionForm input[name="page"]').val(page);$("#user_conditionForm").submit();Loader.showLoader()};User.first=function(){User.changePage(1)};User.end=function(){User.changePage(parseInt($("#totalPage").html()))};User.back=function(){User.changePage(parseInt($("#page").val())-1)};User.next=function(){User.changePage(parseInt($("#page").val())+1)};User.gotoPage=function(){User.changePage(parseInt($("#anyPage").val()))};User.initPageButton=function(){if(parseInt($("#currentPage").html())>1){$("#user_first").show();$("#user_back").show()}else{$("#user_first").hide();$("#user_back").hide()}if(parseInt($("#currentPage").html())<parseInt($("#totalPage").html())){$("#user_next").show();$("#user_last").show()}else{$("#user_next").hide();$("#user_last").hide()}};Utils={};Utils.check_email=function(obj){var reg=/^[a-zA-Z0-9_-]+(\.([a-zA-Z0-9_-])+)*@[a-zA-Z0-9_-]+[.][a-zA-Z0-9_-]+([.][a-zA-Z0-9_-]+)*$/;if(obj.value!=""&&!reg.test(obj.value)){obj.select();alert("电子邮箱格式输入错误！");obj.value="";obj.focus();return false}else{return true}};Utils.check_telephone=function(obj){var reg=/^[1][358]\d{9}$/;if(obj.value!=""&&!reg.test(obj.value)){alert("手机号码格式输入错误！");obj.value="";obj.focus();return false}else{return true}};Utils.transform=function(data){if(data==null){return""}else{return data}};Utils.is_array=function(value){return Object.prototype.toString.apply(value)==="[object Array]"};